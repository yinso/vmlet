// Generated by CoffeeScript 1.4.0
(function() {
  var ANF, AST, CPS, CompileTimeEnvironment, Environment, Promise, Runtime, Session, Unit, baseEnv, compiler, errorlet, fs, loglet, parser, util, vm,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __slice = [].slice;

  vm = require('vm');

  loglet = require('loglet');

  errorlet = require('errorlet');

  Environment = require('./environment');

  parser = require('./parser');

  AST = require('./ast');

  ANF = require('./anf');

  CPS = require('./cps');

  compiler = require('./anfcompiler');

  baseEnv = require('./baseenv');

  Unit = require('./unit');

  util = require('./util');

  Promise = require('bluebird');

  fs = require('fs');

  CompileTimeEnvironment = (function(_super) {

    __extends(CompileTimeEnvironment, _super);

    function CompileTimeEnvironment(inner) {
      this.inner = inner;
    }

    CompileTimeEnvironment.prototype.has = function(key) {
      return this.inner.has(key);
    };

    CompileTimeEnvironment.prototype.get = function(key) {
      return AST.make('proxyval', key, this.inner.get(key), function(ast) {
        return "_rt.get(" + (JSON.stringify(ast.name)) + ")";
      });
    };

    return CompileTimeEnvironment;

  })(Environment);

  Session = (function() {

    function Session(cb) {
      this.cb = cb;
    }

    Session.prototype.result = function(v) {
      return {
        __vmlet_result: v
      };
    };

    Session.prototype.isResult = function(v) {
      return (v != null ? v.__vmlet_result : void 0) || (v !== void 0 && v !== null);
    };

    Session.prototype.unbind = function(v) {
      if (v != null ? v.__vmlet_result : void 0) {
        return v.__vmlet_result;
      } else {
        return v;
      }
    };

    Session.prototype.tco = function() {
      var args, func, funcall, res;
      func = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
      funcall = this.tail.apply(this, [func].concat(__slice.call(args)));
      while (funcall.func !== this.cb) {
        res = funcall.func.apply(funcall, funcall.args);
        if (this.isResult(res)) {
          this.cb(null, this.unbind(res));
        } else if (res.func && res.args && res.cb) {
          return this.tcoAsync.apply(this, [res.fun].concat(__slice.call(res.args), [res.cb]));
        } else if (res.func && res.args) {
          funcall = res;
        }
      }
      return this.cb.apply(this, [null].concat(__slice.call(funcall.args)));
    };

    Session.prototype.tcoAsync = function() {
      var args, cb, func, _i;
      func = arguments[0], args = 3 <= arguments.length ? __slice.call(arguments, 1, _i = arguments.length - 1) : (_i = 1, []), cb = arguments[_i++];
    };

    Session.prototype.tail = function() {
      var args, func;
      func = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
      return {
        func: func,
        args: args
      };
    };

    Session.prototype.async = function() {
      var args, cb, func, _i;
      func = arguments[0], args = 3 <= arguments.length ? __slice.call(arguments, 1, _i = arguments.length - 1) : (_i = 1, []), cb = arguments[_i++];
      return {
        func: func,
        args: args,
        cb: cb
      };
    };

    return Session;

  })();

  Runtime = (function() {

    function Runtime(baseEnv) {
      this.baseEnv = baseEnv != null ? baseEnv : baseEnv;
      loglet.log('Runtime.ctor');
      this.parser = parser;
      this.compiler = compiler;
      this.defineSync('+', function(_rt) {
        return function(a, b) {
          return a + b;
        };
      });
      this.defineSync('-', function(_rt) {
        return function(a, b) {
          return a - b;
        };
      });
      this.defineSync('*', function(_rt) {
        return function(a, b) {
          return a * b;
        };
      });
      this.defineSync('%', function(_rt) {
        return function(a, b) {
          return a % b;
        };
      });
      this.defineSync('>', function(_rt) {
        return function(a, b) {
          return a > b;
        };
      });
      this.defineSync('>=', function(_rt) {
        return function(a, b) {
          return a >= b;
        };
      });
      this.defineSync('<=', function(_rt) {
        return function(a, b) {
          return a <= b;
        };
      });
      this.defineSync('<', function(_rt) {
        return function(a, b) {
          return a < b;
        };
      });
      this.defineSync('==', function(_rt) {
        return function(a, b) {
          return a === b;
        };
      });
      this.defineSync('!=', function(_rt) {
        return function(a, b) {
          return a !== b;
        };
      });
      this.defineSync('isNumber', function(_rt) {
        return function(a) {
          return typeof a === 'number' || a instanceof Number;
        };
      });
      this.define('console', {
        log: this.makeSync(function(_rt) {
          return function() {
            var args;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            console.log.apply(console, args);
            return Unit.unit;
          };
        }),
        time: this.makeSync(function(_rt) {
          return function() {
            var args;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            console.time.apply(console, args);
            return Unit.unit;
          };
        }),
        timeEnd: this.makeSync(function(_rt) {
          return function() {
            var args;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            console.timeEnd.apply(console, args);
            return Unit.unit;
          };
        }),
        debug: this.makeSync(function(_rt) {
          return function() {
            var args;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            console.debug.apply(console, args);
            return Unit.unit;
          };
        }),
        error: this.makeSync(function(_rt) {
          return function() {
            var args;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            console.error.apply(console, args);
            return Unit.unit;
          };
        })
      });
      this.define('fs', {
        readFile: this.makeAsync(function(_rt) {
          var readFile;
          readFile = _rt.member(fs, 'readFile');
          return function(filePath, options, cb) {
            return readFile(filePath, options, cb);
          };
        })
      });
      this.context = vm.createContext({
        _rt: this,
        console: console,
        process: process
      });
      this.compileEnv = new CompileTimeEnvironment(this.baseEnv);
    }

    Runtime.prototype.unit = Unit.unit;

    Runtime.prototype.define = function(key, val) {
      return baseEnv.define(key, val);
    };

    Runtime.prototype.makeSync = function(funcMaker) {
      var func;
      func = funcMaker(this);
      func.__vmlet = {
        sync: true
      };
      return func;
    };

    Runtime.prototype.makeAsync = function(funcMaker) {
      var func;
      func = funcMaker(this);
      func.__vmlet = {
        async: true
      };
      return func;
    };

    Runtime.prototype.defineSync = function(key, funcMaker) {
      return this.define(key, this.makeSync(funcMaker));
    };

    Runtime.prototype.defineAsync = function(key, funcMaker) {
      return this.define(key, this.makeAsync(funcMaker));
    };

    Runtime.prototype["eval"] = function(stmt, cb) {
      var anf, ast, compiled, cps,
        _this = this;
      if (stmt === ':context') {
        return cb(null, this.context);
      } else if (stmt === ':env') {
        return cb(null, this.baseEnv);
      }
      try {
        loglet.log('-------- Runtime.eval =>', stmt);
        ast = this.parser.parse(stmt);
        loglet.log('-------- Runtime.AST =>', ast);
        anf = ANF.transform(ast, this.compileEnv);
        loglet.log('-------- Runtime.ANF =>', anf);
        cps = CPS.transform(anf);
        loglet.log('-------- Runtime.CPS =>', cps);
        compiled = this.compiler.compile(cps);
        loglet.log('-------- Runtime.compile =>', compiled);
        compiler = vm.runInContext(compiled, this.context);
        loglet.log('-------- Runtime.compiler =>', compiler);
        try {
          return compiler(this, function(err, res) {
            if (err) {
              return cb(err);
            } else if (res instanceof Unit) {
              return cb(null);
            } else if (_this.isResult(res)) {
              return cb(null, _this.unbind(res));
            } else {
              return cb(err, res);
            }
          });
        } catch (e) {
          return cb(e);
        }
      } catch (e) {
        return cb(e);
      }
    };

    Runtime.prototype.get = function(key) {
      return this.baseEnv.get(key);
    };

    Runtime.prototype.member = function(obj, key) {
      var member;
      member = obj[key];
      if (util.isFunction(member)) {
        return function() {
          var args;
          args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
          return obj[key].apply(obj, args);
        };
      } else {
        return member;
      }
    };

    Runtime.prototype.promise = function() {
      var args, cb, func, p, _i;
      func = arguments[0], args = 3 <= arguments.length ? __slice.call(arguments, 1, _i = arguments.length - 1) : (_i = 1, []), cb = arguments[_i++];
      loglet.log('_rt.promise', func, args, cb);
      p = new Promise(function(ok, fail) {
        return func.apply(null, __slice.call(args).concat([function(err, res) {
          loglet.log('_rt.promise.call', err, res);
          if (err) {
            return fail(err);
          } else {
            return ok(res);
          }
        }]));
      });
      p.next = cb;
      return p;
    };

    Runtime.prototype.tailAsync = function() {
      var args, cb, func, _i;
      func = arguments[0], args = 3 <= arguments.length ? __slice.call(arguments, 1, _i = arguments.length - 1) : (_i = 1, []), cb = arguments[_i++];
      return {
        tail: func,
        args: args,
        cb: cb
      };
    };

    Runtime.prototype.tail = function() {
      var args, func;
      func = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
      return {
        tail: func,
        args: args
      };
    };

    Runtime.prototype.result = function(v) {
      return {
        __vmlet_result: v
      };
    };

    Runtime.prototype.isResult = function(v) {
      return (v != null ? v.__vmlet_result : void 0) || (v !== void 0 && v !== null);
    };

    Runtime.prototype.unbind = function(v) {
      if (v != null ? v.__vmlet_result : void 0) {
        return v.__vmlet_result;
      } else {
        return v;
      }
    };

    Runtime.prototype.tco = function() {
      var args, cb, func, _i;
      func = arguments[0], args = 3 <= arguments.length ? __slice.call(arguments, 1, _i = arguments.length - 1) : (_i = 1, []), cb = arguments[_i++];
      if (!util.isFunction(func)) {
        if (func instanceof Unit) {
          return cb(null);
        } else {
          return cb(null, func);
        }
      } else {
        return this._tco(func, args, cb);
      }
    };

    Runtime.prototype["while"] = function(cond, ifTrue, ifFalse) {
      var self;
      self = this;
      return self.tail(cond, function(err, res) {
        if (err) {
          return self.tail(ifFalse, err);
        } else if (!res) {
          return self.tail(isFalse, null, cb);
        } else {
          return self["while"](cond, ifTrue, ifFalse, cb);
        }
      });
    };

    Runtime.prototype._tco = function(func, args, cb) {
      var funcall, res, _ref;
      if ((_ref = func.__vmlet) != null ? _ref.async : void 0) {
        args.push(cb);
      }
      funcall = {
        tail: func,
        args: args,
        cb: cb
      };
      while (cb !== funcall.tail) {
        try {
          res = funcall.tail.apply(funcall, funcall.args);
          if ((res != null ? res.tail : void 0) && (res != null ? res.cb : void 0)) {
            return this._tcoAsync(res, cb);
          } else if (res != null ? res.tail : void 0) {
            funcall = res;
          } else if (this.isResult(res)) {
            if (res instanceof Unit) {
              return cb(null);
            }
            return cb(null, this.unbind(res));
          } else {
            return cb(errorlet.create({
              error: 'invalid_tco_function_return',
              value: res
            }));
          }
        } catch (e) {
          return cb(e);
        }
      }
      return tail.tail.apply(tail, tail.args);
    };

    Runtime.prototype.tcoAsync = function() {
      var args, cb, func, self, _i;
      func = arguments[0], args = 3 <= arguments.length ? __slice.call(arguments, 1, _i = arguments.length - 1) : (_i = 1, []), cb = arguments[_i++];
      self = this;
      return funcall.tail.apply(funcall, __slice.call(funcall.args).concat([function(err, res) {
        if (err) {
          return cb(err);
        } else {

        }
      }]));
    };

    Runtime.prototype._tcoAsync = function(funcall, cb) {
      var self;
      self = this;
      return funcall.tail.apply(funcall, __slice.call(funcall.args).concat([function(err, res) {}]));
    };

    return Runtime;

  })();

  module.exports = Runtime;

}).call(this);
