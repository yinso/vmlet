// Generated by CoffeeScript 1.4.0
(function() {
  var AST, ESCompiler, Environment, TR, escodegen, esnode,
    __slice = [].slice;

  escodegen = require('escodegen');

  esnode = require('./esnode');

  AST = require('./ast');

  TR = require('./trace');

  Environment = require('./symboltable');

  ESCompiler = (function() {

    function ESCompiler() {}

    ESCompiler.compile = function(ast) {
      if (!this.reg) {
        this.reg = new this();
      }
      return this.reg.compile(ast);
    };

    ESCompiler.prototype.compile = function(ast) {
      var node;
      node = this.run(ast, new Environment());
      return '(' + escodegen.generate(node) + ')';
    };

    ESCompiler.prototype.run = function(ast, env, res) {
      var type;
      type = "_" + (ast.type());
      if (this[type]) {
        return this[type](ast, env, res);
      } else {
        throw new Error("ESCompiler.unknown_ast: " + (ast.type()));
      }
    };

    ESCompiler.prototype._number = function(ast, env) {
      if (ast.value < 0) {
        return esnode.unary('-', esnode.literal(-ast.value));
      } else {
        return esnode.literal(ast.value);
      }
    };

    ESCompiler.prototype._string = function(ast, env) {
      return esnode.literal(ast.value);
    };

    ESCompiler.prototype._bool = function(ast, env) {
      return esnode.literal(ast.value);
    };

    ESCompiler.prototype._null = function(ast, env) {
      return esnode.null_();
    };

    ESCompiler.prototype._unit = function(ast, env) {
      return esnode.undefined_();
    };

    ESCompiler.prototype._member = function(ast, env) {
      var head, key, runtimeID;
      head = this.run(ast.head, env);
      key = ast.key.type() === 'symbol' ? esnode.literal(ast.key.value) : this.run(ast.key, env);
      runtimeID = this.run(AST.runtimeID, env);
      return esnode.funcall(esnode.member(runtimeID, esnode.identifier('member')), [head, key]);
    };

    ESCompiler.prototype._symbol = function(ast, env) {
      var sym;
      sym = env.alias(ast);
      return esnode.identifier(sym.value);
    };

    ESCompiler.prototype._object = function(ast, env) {
      var key, val;
      return esnode.object((function() {
        var _i, _len, _ref, _ref1, _results;
        _ref = ast.value;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          _ref1 = _ref[_i], key = _ref1[0], val = _ref1[1];
          _results.push([key, this.run(val, env)]);
        }
        return _results;
      }).call(this));
    };

    ESCompiler.prototype._array = function(ast, env) {
      var item;
      return esnode.array((function() {
        var _i, _len, _ref, _results;
        _ref = ast.value;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          item = _ref[_i];
          _results.push(this.run(item, env));
        }
        return _results;
      }).call(this));
    };

    ESCompiler.prototype._block = function(ast, env) {
      var item;
      return esnode.block((function() {
        var _i, _len, _ref, _results;
        _ref = ast.items;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          item = _ref[_i];
          _results.push(this.run(item, env));
        }
        return _results;
      }).call(this));
    };

    ESCompiler.prototype._assign = function(ast, env) {
      return esnode.assign(this.run(ast.name, env), this.run(ast.value, env));
    };

    ESCompiler.prototype._define = function(ast, env) {
      var id, name, value;
      name = (function() {
        switch (ast.name.type()) {
          case 'ref':
            return esnode.literal(ast.name.name.value);
          case 'symbol':
            return esnode.literal(ast.name.value);
          default:
            throw new Error("escompile.define:unknown_name_type: " + ast.name);
        }
      })();
      value = esnode.funcall(esnode.member(this.run(AST.moduleID, env), esnode.identifier('define')), [name, this.run(ast.value, new Environment(env))]);
      id = (function() {
        switch (ast.name.type()) {
          case 'ref':
            return this.run(ast.name.normalName(), env);
          case 'symbol':
            return this.run(ast.name, env);
          default:
            throw new Error("escompile.define:unknown_name_type: " + ast.name);
        }
      }).call(this);
      return esnode.declare('var', [id, value]);
    };

    ESCompiler.prototype._local = function(ast, env) {
      var name;
      name = this.run(ast.name, env);
      if (!ast.value) {
        return esnode.declare('var', [name]);
      } else {
        return esnode.declare('var', [name, this.run(ast.value, env)]);
      }
    };

    ESCompiler.prototype._ref = function(ast, env) {
      var _ref;
      if (((_ref = ast.value) != null ? _ref.type() : void 0) === 'proxyval') {
        return this.run(ast.value, env);
      } else if (ast.isDefine) {
        return esnode.funcall(esnode.member(this.run(AST.moduleID, env), esnode.identifier('get')), [esnode.literal(ast.name.value)]);
      } else {
        return this.run(ast.name, env);
      }
    };

    ESCompiler.prototype._proxyval = function(ast, env) {
      var res;
      res = typeof ast.compiler === 'function' || ast.compiler instanceof Function ? ast.compiler(env) : ast.compiler instanceof AST ? this.run(ast.compiler, env) : this.run(ast.name, env);
      return res;
    };

    ESCompiler.prototype._param = function(ast, env) {
      return this.run(ast.name, env);
    };

    ESCompiler.prototype._procedure = function(ast, env) {
      var func, maker, name, param;
      name = ast.name ? this.run(ast.name, env) : null;
      func = esnode["function"](name, (function() {
        var _i, _len, _ref, _results;
        _ref = ast.params;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          param = _ref[_i];
          _results.push(this.run(param, env));
        }
        return _results;
      }).call(this), this.run(ast.body, env));
      maker = esnode.member(this.run(AST.runtimeID, env), esnode.identifier('proc'));
      return esnode.funcall(maker, [func]);
    };

    ESCompiler.prototype._task = function(ast, env) {
      var name, param;
      name = ast.name ? this.run(ast.name, env) : null;
      return esnode["function"](name, (function() {
        var _i, _len, _ref, _results;
        _ref = ast.params;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          param = _ref[_i];
          _results.push(this.run(param, env));
        }
        return _results;
      }).call(this), this.run(ast.body, env));
    };

    ESCompiler.prototype._if = function(ast, env) {
      return esnode["if"](this.run(ast.cond, env), this.run(ast.then, env), this.run(ast["else"], env));
    };

    ESCompiler.prototype._funcall = function(ast, env) {
      var arg;
      return esnode.funcall(this.run(ast.funcall, env), (function() {
        var _i, _len, _ref, _results;
        _ref = ast.args;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          arg = _ref[_i];
          _results.push(this.run(arg, env));
        }
        return _results;
      }).call(this));
    };

    ESCompiler.prototype._taskcall = function(ast, env) {
      var arg;
      return esnode.funcall(this.run(ast.funcall, env), (function() {
        var _i, _len, _ref, _results;
        _ref = ast.args;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          arg = _ref[_i];
          _results.push(this.run(arg, env));
        }
        return _results;
      }).call(this));
    };

    ESCompiler.prototype._return = function(ast, env) {
      return esnode["return"](this.run(ast.value, env));
    };

    ESCompiler.prototype._binary = function(ast, env) {
      return esnode.binary(ast.op, this.run(ast.lhs, env), this.run(ast.rhs, env));
    };

    ESCompiler.prototype._throw = function(ast, env) {
      return esnode["throw"](this.run(ast.value, env));
    };

    ESCompiler.prototype._catch = function(ast, env) {
      return esnode["catch"](this.run(ast.param, env), this.run(ast.body, env));
    };

    ESCompiler.prototype._finally = function(ast, env) {
      return this.run(ast, env);
    };

    ESCompiler.prototype._try = function(ast, env) {
      var exp;
      return esnode["try"](this.run(ast.body, env), (function() {
        var _i, _len, _ref, _results;
        _ref = ast.catches;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          exp = _ref[_i];
          _results.push(this._catch(exp, env));
        }
        return _results;
      }).call(this), ast["finally"] ? this._finally(ast["finally"], env) : null);
    };

    ESCompiler.prototype._toplevel = function(ast, env) {
      var imp, imports, params, proc, _rt;
      _rt = this.run(AST.runtimeID, env);
      imports = esnode.array((function() {
        var _i, _len, _ref, _results;
        _ref = ast.imports;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          imp = _ref[_i];
          _results.push(this._importSpec(imp, env));
        }
        return _results;
      }).call(this));
      params = [this.run(ast.moduleParam, env)].concat((function() {
        var _i, _len, _ref, _results;
        _ref = ast.imports;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          imp = _ref[_i];
          _results.push(this._importID(imp, env));
        }
        return _results;
      }).call(this)).concat([this.run(ast.callbackParam, env)]);
      proc = esnode["function"](null, params, this.run(ast.body, env));
      return esnode.funcall(esnode.member(_rt, esnode.identifier('toplevel')), [imports, proc]);
    };

    ESCompiler.prototype._module = function(ast, env) {
      var imp, imports, params, proc, _rt;
      _rt = this.run(AST.runtimeID, env);
      imports = esnode.array((function() {
        var _i, _len, _ref, _results;
        _ref = ast.imports;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          imp = _ref[_i];
          _results.push(this._importSpec(imp, env));
        }
        return _results;
      }).call(this));
      params = [this.run(ast.moduleParam, env)].concat((function() {
        var _i, _len, _ref, _results;
        _ref = ast.imports;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          imp = _ref[_i];
          _results.push(this._importID(imp, env));
        }
        return _results;
      }).call(this)).concat([this.run(ast.callbackParam, env)]);
      proc = esnode["function"](null, params, this.run(ast.body, env));
      return esnode.funcall(esnode.member(_rt, esnode.identifier('module')), [this.run(ast.spec, env), imports, proc]);
    };

    ESCompiler.prototype._importSpec = function(ast, env) {
      return this.run(ast.spec, env);
    };

    ESCompiler.prototype._importID = function(ast, env) {
      return this.run(ast.idParam, env);
    };

    ESCompiler.prototype._importBinding = function(ast, binding, env) {
      return [this.run(binding.as, env), esnode.member(this._importID(ast, env), this.run(binding.spec, env))];
    };

    ESCompiler.prototype._import = function(ast, env) {
      var binding;
      return esnode.declare.apply(esnode, ['var'].concat(__slice.call((function() {
        var _i, _len, _ref, _results;
        _ref = ast.bindings;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          binding = _ref[_i];
          _results.push(this._importBidning(ast, binding, env));
        }
        return _results;
      }).call(this))));
    };

    ESCompiler.prototype._export = function(ast, env) {
      var binding;
      return esnode.funcall(esnode.member(this.run(AST.moduleID, env), esnode.identifier('export')), [
        esnode.object((function() {
          var _i, _len, _ref, _results;
          _ref = ast.bindings;
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            binding = _ref[_i];
            _results.push([binding.as.value, this.run(binding.spec, env)]);
          }
          return _results;
        }).call(this))
      ]);
    };

    ESCompiler.prototype._while = function(ast, env) {
      return esnode["while"](this.run(ast.cond, env), this.run(ast.block, env));
    };

    ESCompiler.prototype._switch = function(ast, env) {
      var c;
      return esnode["switch"](this.run(ast.cond, env), (function() {
        var _i, _len, _ref, _results;
        _ref = ast.cases;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          c = _ref[_i];
          _results.push(this.run(c, env));
        }
        return _results;
      }).call(this));
    };

    ESCompiler.prototype._case = function(ast, env) {
      var body, i, item;
      body = (function() {
        var _i, _len, _ref, _results;
        switch (ast.exp.type()) {
          case 'block':
            _ref = ast.exp.items;
            _results = [];
            for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
              item = _ref[i];
              _results.push(this.run(item, env));
            }
            return _results;
            break;
          default:
            return [this.run(item, env)];
        }
      }).call(this);
      return esnode["case"](this.run(ast.cond, env), body);
    };

    ESCompiler.prototype._defaultCase = function(ast, env) {
      return esnode.defaultCase(this.run(ast.exp, env));
    };

    ESCompiler.prototype._continue = function(ast, env) {
      return esnode["continue"]();
    };

    ESCompiler.prototype._break = function(ast, env) {
      return esnode["break"]();
    };

    return ESCompiler;

  })();

  module.exports = ESCompiler;

}).call(this);
